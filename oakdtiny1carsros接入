# 1. æ·»åŠ  OAK-D çš„ USB è§„åˆ™ (è¿™ä¸€æ­¥å¿…é¡»åœ¨å®¿ä¸»æœºåšï¼)
echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="03e7", MODE="0666"' | sudo tee /etc/udev/rules.d/80-movidius.rules
sudo udevadm control --reload-rules && sudo udevadm trigger


sudo docker run -it \
    --name ros1_dev \
    --net=host \
    --gpus all \
    --env="NVIDIA_DRIVER_CAPABILITIES=all" \
    --env="DISPLAY" \
    --env="QT_X11_NO_MITSHM=1" \
    --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
    osrf/ros:noetic-desktop-full \
    bash

å…ˆå‰åˆ›å»ºå®¹å™¨çš„å‘½ä»¤

sudo docker rm -f ros1_dev
åˆ é™¤ä¹‹å‰çš„æ—§å®¹å™¨

sudo docker run -it \
    --name ros1_dev \
    --net=host \
    --privileged \
    --gpus all \
    --env="NVIDIA_DRIVER_CAPABILITIES=all" \
    --env="DISPLAY=$DISPLAY" \
    --env="QT_X11_NO_MITSHM=1" \
    --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
    --volume="/dev/bus/usb:/dev/bus/usb" \
    osrf/ros:noetic-desktop-full \
    bash


åšäº†å“ªäº›å…³é”®ä¿®æ”¹ï¼Ÿ
--volume="/dev/bus/usb:/dev/bus/usb" (æ–°å¢)
ä½œç”¨ï¼š æŠŠ Ubuntu 25.04 å®¿ä¸»æœºçš„æ‰€æœ‰ USB æ¥å£â€œå€Ÿâ€ç»™ Docker å®¹å™¨ç”¨ã€‚
åæœï¼š å¦‚æœä¸åŠ è¿™ä¸€å¥ï¼Œä½ åœ¨å®¹å™¨é‡Œè¾“å…¥ lsusb æ˜¯ç©ºçš„ï¼ŒOAK-D å’Œ Tiny1-C æ ¹æœ¬è¿ä¸ä¸Šã€‚
--privileged (æ–°å¢)
ä½œç”¨ï¼š ç»™å®¹å™¨â€œè¶…çº§ç®¡ç†å‘˜â€æƒé™ï¼Œå…è®¸å®ƒç›´æ¥æ§åˆ¶ç¡¬ä»¶è®¾å¤‡ã€‚
OAK-D å¿…é€‰ï¼š OAK-D å¯åŠ¨æ—¶ï¼ŒUSB ID ä¼šä» 03e7:2485 (Bootloader) å˜æˆ 03e7:f63b (Myriad X)ã€‚æ™®é€šå®¹å™¨ä¼šå› ä¸ºå®‰å…¨é™åˆ¶é˜»æ­¢è¿™ç§â€œå˜èº«â€ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚åªæœ‰åŠ äº† --privileged æ‰èƒ½å¹³æ»‘è¿‡æ¸¡ã€‚
DISPLAY=$DISPLAY (å¾®è°ƒ)
ä½ ä¹‹å‰å†™çš„æ˜¯ --env="DISPLAY"ï¼Œè¿™ä¾èµ–äºå®¿ä¸»æœºç¯å¢ƒå˜é‡æ˜¯å¦é€ä¼ ã€‚å†™æˆ --env="DISPLAY=$DISPLAY" æ›´ç¨³å¦¥ï¼Œç¡®ä¿ Rviz èƒ½å¼¹å‡ºæ¥ã€‚



# 3. å…è®¸æœ¬åœ° X11 æ˜¾ç¤ºï¼ˆæ¯æ¬¡é‡å¯ç”µè„‘åå¯èƒ½éƒ½éœ€è¦è¾“è¿™ä¸€å¥ï¼Œä¸ºäº†è®© Docker èƒ½å¼¹çª—ï¼‰
xhost +local:root



sudo docker run -it \
    --name ros1_dev \
    --net=host \
    --privileged \
    --gpus all \
    --env="NVIDIA_DRIVER_CAPABILITIES=all" \
    --env="DISPLAY=$DISPLAY" \
    --env="QT_X11_NO_MITSHM=1" \
    --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
    --volume="/dev/bus/usb:/dev/bus/usb" \
    --volume="/home/$(whoami)/knotted3:/root/catkin_ws/src" \
    osrf/ros:noetic-desktop-full \
    bash


--volume="/home/...:/root/catkin_ws/src"ï¼šè¿™æ˜¯çµé­‚ã€‚å®ƒæŠŠä½ åœ¨å®¿ä¸»æœºå»ºç«‹çš„ my_ghost_project æ–‡ä»¶å¤¹ï¼Œç›´æ¥æ˜ å°„åˆ°äº†å®¹å™¨é‡Œçš„ /root/catkin_ws/srcã€‚


apt update
apt install -y python3-pip git wget nano usbutils

# å®‰è£… OAK-D ROS é©±åŠ¨
apt install -y ros-noetic-depthai-ros

# å®‰è£… Python åº“ (ç»™ Tiny1-C å’Œ èåˆç®—æ³•ç”¨)
pip3 install opencv-python depthai numpy

pip install depthai==2.28.0.0

# è¿›å…¥å·¥ä½œç©ºé—´æ ¹ç›®å½•
cd /root/catkin_ws/

# ç¬¬ä¸€æ¬¡ç¼–è¯‘ï¼ˆè™½ç„¶ src æ˜¯ç©ºçš„ï¼Œä½†è¿™ä¸€æ­¥ä¼šç”Ÿæˆ build å’Œ devel æ–‡ä»¶å¤¹ï¼‰
catkin_make

# æŠŠç¯å¢ƒç”Ÿæ•ˆå‘½ä»¤å†™å…¥ .bashrc (è¿™æ ·ä¸‹æ¬¡è¿›å®¹å™¨ä¸ç”¨æ‰‹åŠ¨ source)
echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc
echo "source /root/catkin_ws/devel/setup.bash" >> ~/.bashrc
source ~/.bashrc



# è¿›å…¥æºç ç›®å½•
cd /root/catkin_ws/src

# åˆ›å»ºåŠŸèƒ½åŒ… (åŒ…å: ghost_eyesï¼Œä¾èµ–: rospy, cv_bridge, sensor_msgs, vision_msgs)
# vision_msgs æ˜¯ä¸“é—¨ç”¨æ¥å‘æ£€æµ‹æ¡†ï¼ˆBounding Boxï¼‰çš„æ ‡å‡†æ¶ˆæ¯ç±»å‹
catkin_create_pkg ghost_eyes rospy std_msgs sensor_msgs cv_bridge vision_msgs image_transport

# å›åˆ°å·¥ä½œç©ºé—´æ ¹ç›®å½•ç¼–è¯‘ä¸€ä¸‹
cd /root/catkin_ws
catkin_make
source devel/setup.bash


sudo chown -R $USER:$USER ~/knotted3
vscodeåˆ›å»ºscriptsæ–‡ä»¶å¤¹
æˆäºˆæƒé™


ä½ çš„æŒ‚è½½å‘½ä»¤æ˜¯ï¼š
--volume="/home/knottedzz/knotted3:/root/catkin_ws/src"
knotted3æ–‡ä»¶å¤¹é‡Œçœ‹åˆ°çš„æ˜¯ /root/catkin_ws/src é‡Œé¢çš„å†…å®¹

ç¼–è¯‘å¤±è´¥ 
ç¼–è¯‘å›åˆ°catkin_wsæ–‡ä»¶å¤¹å‰ç¼€
apt install ros-noetic-vision-msgs
apt install ros-noetic-image-transport
catkin_make



è°ƒè¯•æ–¹æ³•
ç«¯å£1
roscore

ç«¯å£2
# è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨
sudo docker exec -it ros1_dev bash
source /root/catkin_ws/devel/setup.bash æ¯æ¬¡éƒ½è¦åˆ·æ–°ç¯å¢ƒ æ‰“å¼€æ–°ç»ˆç«¯
rosrun ghost_eyes oakd_node.py

ç»ˆç«¯3 rviz


ä¹‹å‰oakd_nodeé‡Œé¢æ˜¯yolov4tiny æ¨¡å‹ é”šç‚¹é…ç½®æœ‰é—®é¢˜
åé¢æ¢æˆMobileNet-SSD ç‰ˆ


source /root/catkin_ws/devel/setup.bash
source /root/catkin_ws/devel/setup.bash
source /root/catkin_ws/devel/setup.bash
ï¼ï¼ï¼


ç¬¬å››ä¸ªç»ˆç«¯ éªŒè¯yolo/mobilenetæ˜¯å¦åœ¨å·¥ä½œ
å…³é—­rviz
å†æ‰“å¼€ä¸€ä¸ªç»ˆç«¯
source /root/catkin_ws/devel/setup.bash
rostopic echo /ghost/camera/detections

ç†è®ºè¾“å‡ºï¼š
results: 
  - 
    id: 15  <-- (MobileNet-SSDé‡Œ 15ä»£è¡¨ Person)
    score: 0.9823...
    pose: 
      pose: 
        position: 
          x: 0.152  <-- (æ¨ªå‘åæ ‡ 0.15ç±³)
          y: 0.201
          z: 1.543  <-- (æ·±åº¦åæ ‡ 1.54ç±³)



launchæ–¹æ³•
ghost_eyes/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ package.xml
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ oakd_node.py
â””â”€â”€ rviz/  <-- æ–°å»ºçš„ç©ºæ–‡ä»¶å¤¹
ä¿å­˜ oakd.rviz
topic depth and rgb
oak_rgb_frame

ç¼–å†™Launchæ–‡ä»¶å®ç°ä¸€é”®å¯åŠ¨
åœ¨ ghost_eyes æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶å¤¹ launchã€‚
åœ¨ launch æ–‡ä»¶å¤¹é‡Œï¼Œæ–°å»ºæ–‡ä»¶ start.launchã€‚

<launch>
    <!-- 1. å¯åŠ¨ OAK-D é©±åŠ¨èŠ‚ç‚¹ -->
    <node name="oakd_driver" pkg="ghost_eyes" type="oakd_node.py" output="screen" />

    <!-- 2. å‘å¸ƒä¸€ä¸ªé™æ€åæ ‡å˜æ¢ (ä¿®å¤ Rviz é‡Œçš„é»„è‰²è­¦å‘Š) -->
    <!-- è¿™é‡Œçš„å‚æ•° 0 0 0 0 0 0 ä»£è¡¨ç›¸æœºç›¸å¯¹äºä¸–ç•Œåæ ‡ç³»æ²¡æœ‰åç§» -->
    <node pkg="tf" type="static_transform_publisher" name="link1_broadcaster" args="0 0 0 0 0 0 map oak_rgb_frame 100" />

    <!-- 3. å¯åŠ¨ Rvizï¼Œå¹¶åŠ è½½æˆ‘ä»¬ä¿å­˜çš„é…ç½®æ–‡ä»¶ -->
    <!-- $(find ghost_eyes) ä¼šè‡ªåŠ¨æ‰¾åˆ°ä½ çš„åŒ…è·¯å¾„ -->
    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find ghost_eyes)/rviz/oakd.rviz" />
</launch>



æ‰“å¼€ä¸€ä¸ªæ–°çš„dockerç»ˆç«¯
cd /root/catkin_ws
catkin_make
source devel/setup.bash
roslaunch ghost_eyes start.launch


è¿è¡Œä¸€ä¼šå°±ä¼šæ–­å¼€çš„é—®é¢˜
å¦‚æœè¿æ¥ä¸ç¨³å°±æ¢æˆusb 2.0 ç°åœ¨æ˜¯usb3.0
åœ¨oakd_node.pyæ–‡ä»¶é‡Œä¿®æ”¹

éªŒè¯mobilenetçš„æ£€æµ‹æ•ˆæœ
åœ¨oakd_nodeä¸­ä½¿ç”¨opencvå…ˆç”»å¥½å›¾ å†æ‰“åŒ…ç»™rviz
æ–°å»ºoakd_node2 
æ–°å»ºstart_visual.launch

'''å·²ç»å®Œæˆäº†oakdçš„ros1æ¥å…¥'''


å¼€å§‹tiny1-cçš„ros1æ¥å…¥

Tiny1-C çš„æ¥å…¥é€»è¾‘æ¯” OAK-D ç®€å•å¾—å¤šï¼Œå› ä¸ºå®ƒåœ¨ Linux ä¸‹å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ UVC æ‘„åƒå¤´ï¼ˆåƒç½‘ç»œæ‘„åƒå¤´ä¸€æ ·ï¼‰ã€‚
æˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåšä¸¤ä»¶äº‹ï¼š
è¯»å–æ•°æ®ï¼š ç”¨ OpenCV æ‰“å¼€æ‘„åƒå¤´ï¼Œå¼ºåˆ¶è®¾ä¸º 256x192ã€‚
å¤„ç†å‘å¸ƒï¼š æŠŠåŸå§‹æ•°æ®å½’ä¸€åŒ–ï¼ˆæ‹‰ä¼¸å¯¹æ¯”åº¦ï¼‰ï¼Œå˜æˆä¼ªå½©è‰²å›¾åƒå‘å¸ƒç»™ ROSï¼Œæ–¹ä¾¿ä½ åœ¨ Rviz é‡Œçœ‹ã€‚


åˆ›å»ºscripts/tiny1c_node.py
åˆ›å»ºlaunch/tiny_only.launch



sudo docker stop knotted3_ros1
sudo docker start knotted3_ros1
sudo docker exec -it knotted3_ros1 bash
cd root/catkin_ws
source devel/setup.bash
xhost +local:root //å®¹å™¨å¤–ä½¿ç”¨ å…è®¸rvizæ˜¾ç¤º rvizæŠ¥é”™æ—¶ç”¨

LAUNCH
roslaunch ghost_eyes start.launch //oakdæœ€åˆå§‹ç‰ˆæœ¬ ä¸ç”¨ç®¡
roslaunch ghost_eyes strat_visual.launch  //oakdå¸¦æ¡†ç‰ˆæœ¬ æ ‡å®šä¸ç”¨
roslaunch ghost_eyes tiny_only.launch //åªæœ‰çƒ­ä¼ æ„Ÿå™¨ç‰ˆæœ¬
roslaunch ghost_eyes dual_cam.launch // åŒä¼ æ„Ÿå™¨ç‰ˆæœ¬
roslaunch ghost_eyes calibration.launch //oakdçº¢å¤–æ ‡å®š
oakd_at20.launch //at20å’Œoakdæ˜¾ç¤º


SCRIPTS
oakd_node //åˆå§‹ç‰ˆæœ¬ 
oakd_node2 //å¸¦mobilenetè¯†åˆ«
tiny1c_node //çº¢å¤–
oakd_calib_node //è¾“å‡º1920x1080ç»™æ ‡å®šç”¨
calibration_node //æ ‡å®šç”¨ï¼ˆçº¢å¤–å’Œoakdï¼‰OPENCVæ–¹æ³•
at20_node //at20é©±åŠ¨æ¥å£
oakd_at20_time è®¡ç®—æ—¶é—´å·® æœªå®Œæˆ


æ ‡å®š
roslaunch ghost_eyes calibration.launch  //å‘å¸ƒè¯é¢˜
rosrun ghost_eyes calibtation_node.py //opencvæ£‹ç›˜æ ¼æ ‡å®š


rostopic echo /at20/image --noarr -n 1

chmod +x knotted3/ghost_eyes/scripts/oakd_at20_time.py



========================================
ğŸ“· OAK-D å‡ºå‚å†…å‚ (RGB 1080P)
========================================

å†…å‚çŸ©é˜µ (mtx_rgb):
np.array([
    [1513.98876953, 0.00000000, 970.27874756],
    [0.00000000, 1514.04125977, 548.69775391],
    [0.00000000, 0.00000000, 1.00000000]
])

ç•¸å˜ç³»æ•° (dist_rgb):
np.array([-3.819533348083496, 9.725564002990723, 0.00023930289898999035, -6.547127850353718e-05, -5.249636173248291, -3.904806613922119, 10.002168655395508, -5.539272785186768, 0.0, 0.0, 0.0, 0.0, 0.0027119372971355915, 0.0020668236538767815])


